const w="offscreen.html",y="http://localhost:3001/api/recording",p="http://localhost:3000/recording";let i=[],u=null,a=null,c=!1;chrome.runtime.onMessage.addListener(async(e,o,t)=>{try{if(e?.type==="START_RECORDING"){if(c)return console.warn("[background] Already recording"),t({success:!1,error:"Already recording"}),!0;c=!0,i=[],u=null,a=E(),await chrome.storage.local.set({isRecording:!0,currentSessionId:a});const[r]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!r||!r.url||h(r.url))return console.warn("[background] ‚ùå Cannot record restricted URL:",r?.url),c=!1,await chrome.storage.local.set({isRecording:!1}),t({success:!1,error:"Cannot record this page"}),!0;u=r.id,await b(r.id);try{await f(r.id,{type:"START_RECORDING",sessionId:a})}catch(n){console.warn("[background] Content script start failed:",n.message)}return await S(),await R(),chrome.runtime.sendMessage({type:"OFFSCREEN_START",sessionId:a}),console.log("[background] üé¨ Recording started:",a),t({success:!0,sessionId:a}),!0}if(e?.type==="STOP_RECORDING"){if(!c)return console.warn("[background] Not recording"),t({success:!1,error:"Not recording"}),!0;c=!1,await chrome.storage.local.set({isRecording:!1});let r=a,n=!1;if(u)try{const s=await f(u,{type:"STOP_RECORDING"},3,300);s?.sessionData&&(r=s.sessionData.sessionId,await g(s.sessionData),n=!0)}catch(s){console.warn("[background] Content script stop failed:",s.message)}return n||(console.log("[background] Using buffered events:",i.length),await g({sessionId:r,events:i,startTime:Date.now()-6e4,endTime:Date.now(),url:"unknown",viewport:{width:0,height:0}})),chrome.runtime.sendMessage({type:"OFFSCREEN_STOP",sessionId:r}),chrome.tabs.create({url:`${p}/${r}`}),console.log("[background] üõë Recording stopped:",r),i=[],u=null,a=null,t({success:!0,sessionId:r}),!0}if(e?.type==="EVENT_CAPTURED"&&c&&i.push(e.event),e?.type==="OFFSCREEN_PING")return t({ready:!0}),!0}catch(r){console.error("[background] ‚ùå Error:",r),t({success:!1,error:r.message})}return!0});function E(){return`session_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}function h(e){return!e||e.startsWith("chrome://")||e.startsWith("edge://")||e.startsWith("about:")||e.startsWith("chrome-extension://")||e.startsWith("chrome-search://")||e.startsWith("devtools://")}async function f(e,o,t=3,r=200){for(let n=0;n<t;n++)try{return await chrome.tabs.sendMessage(e,o)}catch{if(n===t-1)throw new Error("Content script not responding");await new Promise(l=>setTimeout(l,r))}}async function b(e){try{const o=await chrome.tabs.get(e).catch(()=>null);if(!o||!o.url||h(o.url)){console.warn("[background] Cannot inject into restricted URL");return}await chrome.scripting.executeScript({target:{tabId:e},files:["content-script.js"]}),console.log("[background] ‚úÖ Content script injected")}catch(o){console.error("[background] Injection failed:",o.message)}}async function g(e){try{const o=new FormData;o.append("events",JSON.stringify(e.events||[])),o.append("metadata",JSON.stringify(e));const t=await fetch(`${y}/process-recording`,{method:"POST",body:o});if(!t.ok)throw new Error(`HTTP ${t.status}: ${await t.text()}`);const r=await t.json();return console.log("[background] ‚úÖ Node.js response:",r),r}catch(o){throw console.error("[background] ‚ùå Failed to send to Node:",o),o}}let d=!1;async function S(){if(!await chrome.offscreen.hasDocument()){if(d){for(;!await chrome.offscreen.hasDocument();)await new Promise(e=>setTimeout(e,50));return}d=!0;try{await chrome.offscreen.createDocument({url:w,reasons:["DISPLAY_MEDIA","USER_MEDIA"],justification:"Screen + mic recording"}),console.log("[background] ‚úÖ Offscreen created")}catch(e){console.error("[background] Offscreen creation failed:",e)}finally{d=!1}}}async function R(e=5,o=200){for(let t=0;t<e;t++)try{if((await new Promise((n,s)=>{const l=setTimeout(()=>s(new Error("Timeout")),1e3);chrome.runtime.sendMessage({type:"OFFSCREEN_PING"},m=>{clearTimeout(l),chrome.runtime.lastError?s(chrome.runtime.lastError):n(m)})}))?.ready)return console.log("[background] ‚úÖ Offscreen ready"),!0}catch{t<e-1&&await new Promise(n=>setTimeout(n,o))}return console.warn("[background] ‚ö†Ô∏è Offscreen not ready"),!1}chrome.alarms.create("keepAlive",{periodInMinutes:.33});chrome.alarms.onAlarm.addListener(()=>{chrome.runtime.getPlatformInfo(()=>{})});console.log("[background] ‚úÖ Service Worker Ready");
